<script lang="ts">
  import ZoomSvg from '$lib/holocene/zoom-svg.svelte';
  import type { RootNode } from '$lib/services/workflow-service';
  import { workflowRun } from '$lib/stores/workflow-run';

  import WorkflowElectron from './workflow-electron.svelte';

  $: ({ workflow } = $workflowRun);

  export let root: RootNode;
  export let onNodeClick: (node: RootNode) => void;

  let activeNode: RootNode | undefined;
  let hoverNode: RootNode | undefined;

  $: currentNode =
    root?.workflow?.runId === workflow.runId &&
    root?.workflow?.id === workflow.id;

  const getPositions = (width: number, height: number, zoomLevel: number) => {
    const centerX = width / 2;
    const centerY = height / 2;
    const orbits = {
      root: width / 50 / zoomLevel,
      level1: width / 16 / zoomLevel,
      level2: width / 9 / zoomLevel,
      level3: width / 6 / zoomLevel,
      level4: width / 4 / zoomLevel,
    };
    const radius = 10 / (2 * zoomLevel);
    return {
      centerX,
      centerY,
      orbits,
      radius,
    };
  };

  const onNodeMouseEnter = (node: RootNode) => {
    if (activeNode) return;
    hoverNode = node;
  };

  const onNodeMouseLeave = (_node: RootNode) => {
    if (activeNode) return;
    hoverNode = undefined;
  };

  const nodeClick = (node: RootNode) => {
    if (activeNode === node) {
      activeNode = undefined;
    } else {
      activeNode = node;
    }
    nodeClick(node);
  };
</script>

<div class="w-full rounded-xl border-2 border-subtle bg-primary">
  <ZoomSvg
    initialZoom={0.65}
    maxZoomOut={1}
    maxZoomIn={0.25}
    let:width
    let:height
    let:zoomLevel
    class="spin"
  >
    {@const { centerX, centerY, orbits, radius } = getPositions(
      width,
      height,
      zoomLevel,
    )}
    <circle
      class="stroke-black dark:stroke-white"
      cx={centerX}
      cy={centerY}
      r={orbits.level1}
      stroke-width="1"
      fill-opacity="0"
    />
    <circle
      class="stroke-black opacity-50 dark:stroke-white"
      cx={centerX}
      cy={centerY}
      r={orbits.level2}
      stroke-width="1"
      fill-opacity="0"
    />
    <circle
      class="stroke-black opacity-50 dark:stroke-white"
      cx={centerX}
      cy={centerY}
      r={orbits.level3}
      stroke-width="1"
      fill-opacity="0"
    />
    <circle
      class="stroke-black opacity-50 dark:stroke-white"
      cx={centerX}
      cy={centerY}
      r={orbits.level4}
      stroke-width="1"
      fill-opacity="0"
    />
    {#each root.children as child, i}
      <WorkflowElectron
        index={i}
        node={child}
        parent={root}
        center={{ x: centerX, y: centerY }}
        parentCenter={{ x: centerX, y: centerY }}
        {radius}
        {orbits}
        generation={1}
        {zoomLevel}
        {activeNode}
        {hoverNode}
        {onNodeClick}
        {onNodeMouseEnter}
        {onNodeMouseLeave}
      />
    {/each}
    <g
      class="outline-none"
      role="button"
      tabindex="0"
      on:keypress={() => nodeClick(root)}
      on:click={() => nodeClick(root)}
    >
      {#if currentNode}
        <circle
          class="dark:fill-white"
          cx={centerX}
          cy={centerY}
          r={orbits.root * 1.1}
        />
      {/if}
      <circle
        class={root.workflow.status}
        cx={centerX}
        cy={centerY}
        r={orbits.root}
      />
    </g>
  </ZoomSvg>
</div>

<style lang="postcss">
  .Running {
    fill: #93bbfd;
  }

  .Started {
    fill: #92a4c3;
  }

  .Completed {
    fill: #00f37e;
  }

  .Fired {
    fill: #f8a208;
  }

  .Signaled {
    fill: #d300d8;
  }

  .Failed,
  .Terminated {
    fill: #ff4518;
  }

  .TimedOut {
    fill: #c2570c;
  }

  .Canceled {
    fill: #fed64b;
  }
</style>
